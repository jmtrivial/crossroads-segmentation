<!DOCTYPE html>
<html lang="fr-FR" class="no-js">
    <head>
        <meta charset="UTF-8">
        <title>Crossroad quality evaluation</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@forevolve/bootstrap-dark@1.0.0/dist/css/bootstrap-dark.min.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
                
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-kQtW33rZJAHjgefvhyyzcGF3C5TFyBQBA13V1RKPf4uH+bwyzQxZ6CmMZHmNBEfJ" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
        
        <!-- Library Leaflet -->
        <link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />
        <script src="node_modules/leaflet/dist/leaflet.js"></script>

        <!-- Extension Géoportail pour Leaflet -->
        <script src="node_modules/geoportal-extensions-leaflet/dist/GpPluginLeaflet.js"></script>
        <link rel="stylesheet" data-key="VOTRE-CLEF"  href="node_modules/geoportal-extensions-leaflet/dist/GpPluginLeaflet.css" />
        
        
        
        <script>
            /* TODO
                - add a back button
                - add a free field for comments
                - add a link to street view (new tab) ou google maps
                - capture "back" from navigator
            */
            
            
        
        
            settings_questions = '{ \
                                    "scale": {"question": "Crossroad scale", "type": "multiple_choice", "values": ["correct", "too large", "too small"], "default": "correct" }, \
                                    "nb_branches": { "question": "Number of branches", "type": "multiple_choice", "values": ["correct", "too few", "too much"], "default": "correct" }, \
                                    "branches": { "question": "Branches configuration", "type": "multiple_choice", "values": ["correct", "two or more branches are merged", "one or more branch is split", "merged and split branches"], "default": "correct" }, \
                                    "edges": {"question": "Edge position", "type": "multiple_choice", "values": ["correct", "too far", "too close"], "default": "correct" }, \
                                    "completness": {"question": "Completness", "type": "multiple_choice", "values": ["correct", "missing parts", "excess parts"], "default": "correct" } \
                                  }';
            
            
        
            // from jquery.color.js plugin
            Colors = {};
            Colors.names = {
                blue: "#0000ff",
                lime: "#00ff00",
                yellow: "#ffff00",
                cyan: "#00ffff",
                magenta: "#ff00ff",
                black: "#000000",
                white: "#ffffff",
                brown: "#a52a2a",
                indigo: "#4b0082",
                khaki: "#f0e68c",
                olive: "#808000",
                orange: "#ffa500",
                pink: "#ffc0cb",
                violet: "#800080",
                silver: "#c0c0c0"
            };
            // from https://stackoverflow.com/a/10014969/5319942
            Colors.list = function(nb) {
                var result = [];
                for (var key in Colors.names) {
                    result.push(Colors.names[key]);
                    if (result.length == nb)
                        break;
                }
                return result;

            };

            // shuffle crossroad indexes to browse them in a random order
            function shuffle(array) {
                let currentIndex = array.length,  randomIndex;

                // While there remain elements to shuffle...
                while (currentIndex != 0) {

                    // Pick a remaining element...
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;

                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
                }

                return array;
            }
            
            // create the question interface (used only once, corresponds to the form in the left panel)
            function build_question_interface() {
                questions = "";
                
                window.q_json = JSON.parse(settings_questions);
                
                qid = 0;
                for(var key in window.q_json){
                    if (window.q_json.hasOwnProperty(key)){
                        var q = window.q_json[key];
                        var question_text = q["question"];
                        var values = q["values"];
                        var default_value = q["default"];
                        
                        
                        questions += '<div class="mb-3">';
                        questions += '<label for="question-' + qid + '" class="form-label">' + question_text + '</label>';
                        questions += '<select  id="question-' + qid + '" class="form-select" aria-label="' + question_text + '">';
                        i = 0;

                        for(var k in values) {
                            element = values[k];
                            questions += "<option";
                            if (default_value == element) {
                                questions += " selected";
                            }
                            questions += ' id="q' + qid + '-o' + i+ '" value="' + i + '">' + element + '</option>';
                            i += 1;
                        }

                        questions += "</select>";
                        questions += "</div>";
                        qid += 1;
                    }
                }

                
                $("#questions").html(questions);
                
            }
            
            // update the question interface. Used at each step to update both form and map
            function update_question_interface() {
            
                // left side
                
                $("#crossroad_title").text("Crossroad #" + window.crossroads_index[window.current_id]);
                
                if (window.nb_processed != 0) {
                    $("#download").prop("disabled", false);
                }
                else
                    $("#download").prop('disabled', true); 

                qid = 0;
                for(var key in window.q_json){
                    if (window.q_json.hasOwnProperty(key)){
                        var q = window.q_json[key];
                        var values = q["values"];
                        var default_value = q["default"];
                        i = 0;
                        for(var k in values) {
                            option = $('#q' + qid + '-o' + i);
                            option.prop("selected", option.text() == default_value);
                            i += 1;
                        }
                        qid += 1;
                    }
                }
                
                // right side
                current_crossroad = window.crossroads[window.crossroads_index[window.current_id]];
                // sort using first branches, then crossroad core
                current_crossroad.sort((x1, x2) => x1["type"].localeCompare(x2["type"]));
                
                if (typeof window.map === 'undefined') {
                    window.map = L.map('mapid');

                    L.tileLayer(
                        "https://wxs.ign.fr/jhyvi0fgmnuxvfv0zjzorvdn/geoportail/wmts?" +
                        "&REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0" +
                        "&STYLE=normal" +
                        "&TILEMATRIXSET=PM" +
                        "&FORMAT=image/jpeg"+
                        "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS"+
                        "&TILEMATRIX={z}" +
                        "&TILEROW={y}" +
                        "&TILECOL={x}",
                        {
                            minZoom : 0,
                            maxNativeZoom: 19,
                            maxZoom : 21,
                                    attribution : "IGN-F/Geoportail",
                            tileSize : 256 
                        }
                    ).addTo(window.map);
                }
                else {
                                        
                    // remove the existing crossroad layer
                    if (typeof window.layergroup !== 'undefined') {
                        window.map.removeLayer(window.layergroup);
                    }
                    
                    // TODO remove footer
                }
                
                window.crossroad_layers = [];
                
                
                // build a random list of colors
                colors = Colors.list(current_crossroad.length);
                
                // for each element of the crossroad create a layer     
                for(var eid in current_crossroad) {
                    element = current_crossroad[eid];
                    
                    // build latlng
                    latlng = [];
                    if (element["edges_by_nodes"].length == 0) {
                        if (element["nodes"].length != 0 && element["nodes"]["border"].length != 0) {
                            coord = element["coordinates"][element["nodes"]["border"][0]];
                            latlng.unshift([[coord["y"], coord["x"]], [coord["y"], coord["x"]]]);
                        }
                    }
                    else {
                        for (var eidi in element["edges_by_nodes"]) {
                            edge = element["edges_by_nodes"][eidi];
                            latlng.push([[element["coordinates"][edge[0]]["y"], element["coordinates"][edge[0]]["x"]],
                                        [element["coordinates"][edge[1]]["y"], element["coordinates"][edge[1]]["x"]]]);
                        }
                    }
                    
                    // choose color
                    if (element["type"] == "branch") {
                        options = {color: colors[eid]};
                    }
                    else if (element["type"] == "crossroad") {
                        options = {color: 'red', weight: '10', opacity: '0.6'};
                    }
                                        
                    // create crossroad layer
                    window.crossroad_layers.push(L.polyline(latlng, options));
                }
                
                // create a layergroup
                window.layergroup = L.featureGroup(window.crossroad_layers).addTo(window.map);
                
                // set the zoom adjusted on this layergroup
                window.map.fitBounds(window.layergroup.getBounds());

                // TODO add a footer with a link on google street view
                
            }
            
            // get answers from the form and store them in the data structure (that contains the initial json)
            function set_current_crossroad_evaluation() {
                result = {"type": "evaluation"};
                
                qid = 0;
                for(var key in window.q_json){
                    if (window.q_json.hasOwnProperty(key)){
                        var q = window.q_json[key];
                        var values = q["values"];
                        var default_value = q["default"];
                        option = $('#question-' + qid + " option:selected");
                        result[key] = option.text();
                        qid += 1;
                    }
                }

                window.crossroads[window.crossroads_index[window.current_id]].push(result);
            }
            
            
            function compute_nb_processed() {
                nb = 0;
                return window.crossroads.filter(function(item){
                    return item.hasOwnProperty("evaluation");
                }).length;
            }
            
            function has_evaluation_current_crossroad() {
                current = window.crossroads[window.crossroads_index[window.current_id]];
                for (var idc in current) {
                    if (current[idc]["type"] == "evaluation")
                        return true;
                }
                return false;
            }
            
            function find_next_open_question() {
                while(has_evaluation_current_crossroad()) {
                    window.current_id += 1;
                }
            }
            
            function set_next_question() {
                find_next_open_question();
                
                $("#nb_processed").text(window.nb_processed);
                
                update_question_interface();
                
            }
            
            function download(evt) {
                    var a = document.createElement("a");
                    var file = new Blob([JSON.stringify(window.crossroads)], { type: "text/plain;charset=utf-8" });
                    a.href = URL.createObjectURL(file);
                    var d = new Date();
                    a.download = window.input_filename.replace(/\.[^/.]+$/, "") + "-evaluation-" + d.toISOString() + ".json";
                    a.click();
            }
            
            // init interface
            function start_questions() {
                $("#main-container>div").css("display", "none");
                $("#question").css("display", "block");
                
                window.current_id = 0;
                
                
                set_next_question();
            }

            function ask_settings() {
                $("#main-container>div").css("display", "none");
                $("#settings").css("display", "block");
            }
            
            function build_index() {
                window.crossroads_index = Array.from(Array(window.crossroads.length).keys());
            }

            function the_end() {
                $("#main-container>div").css("display", "none");
                $("#the_end").css("display", "block");
            }
        
            $(document).ready(function () {
                $("#next").click(function(evt) {
                    set_current_crossroad_evaluation();
                    window.nb_processed += 1;
                    if (window.crossroads.length == window.nb_processed) {
                        the_end();
                    }
                    else {
                        set_next_question();
                    }
                });
                
                $("#download").click(download);
                $("#download_end").click(download);
                
                $("#regular").click(function(evt) {
                    build_index();
                    start_questions();
                });

                $("#shuffle").click(function(evt) {
                    build_index();
                    shuffle(window.crossroads_index);
                    start_questions();
                });

                $("#inputFile").on("change", function handleFileSelect(evt) {
                    if (evt == null || evt.target == null || evt.target.files == null || evt.target.files.length == 0) {
                        console.log("no input file");
                        return;
                    }

                    var file = evt.target.files[0];

                    if (file.type != "application/json") {
                        console.log("bad format");
                        return;
                    }
                    
                    const fr = new FileReader();

                    fr.addEventListener("load", e => {
                        $("#main-container>div").css("display", "none");
                        $("#chargement").css("display", "block");
                        
                        // load data
                        window.crossroads = JSON.parse(fr.result);
                        
                        // set numbers
                        $("#nb_crossroads").text(window.crossroads.length);
                        $("#settings_nb_crossroads").text(window.crossroads.length);
                        window.nb_processed = compute_nb_processed();
                        $("#nb_processed").text(window.nb_processed);

                        ask_settings();
                    });

                    fr.readAsText(file);
                    window.input_filename = evt.target.files[0].name;
                });
                
                build_question_interface();

            });
            
        </script>
        <style>
            #question, #chargement, #settings, #the_end { display: none; }
            
            #mapid { height: 100%; }
        </style>

    </head>
	<body>
        <div class="container-xxl" id="main-container">
            
            <h1>Crossroad quality evaluation</h1>
             <p class="lead">By answering the following questions, you will evaluate the quality of a junction detection and segmentation algorithm in <a href="https://www.openstreetmap.org/">OpenStreetMap</a>, and participate in the <a href="https://activmap.limos.fr/">ANR ACTIVmap project</a>.
            </p>
            <div id="start">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">
                        <p>Select a <code>json</code> file</p>
                        <div class="btn btn-primary btn-block" style="width: 100%">
                                        <label style="padding: 0" tkey="chooseFile">Load crossroads</label>
                                            <input type="file" id="inputFile" name="files[]" accept="application/json" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer; opacity: 0">
                        </div>
                 </div>
            </div>
            <div id="chargement">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">Chargement des données...</div>
            </div>
            <div id="settings">
                <div class="position-absolute top-50 start-50 translate-middle fs-1 col-6">
                    <p>Do you want to shuffle the <span id="settings_nb_crossroads"></span> crossroads, or evaluate them in regular order?</p>
                    <div class="container mt-3">
                        <div class="row">
                        <div class="col-6">
                            <button id="regular" class="btn btn-primary btn-block form-control" type="button">Regular</button>
                        </div>
                        <div  class="col-6">
                            <button id="shuffle" class="btn btn-primary btn-block form-control" type="button">Shuffle</button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="question">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title" id="crossroad_title"></h2>
                        <div class="row">
                            <div class="col-6" id="questions">
                            
                            </div>
                            <div class="col-6">
                                    <div id="mapid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="container mt-3">
                    <div class="row">
                    <div class="col-6">
                        <button id="download" class="btn btn-secondary" style="width: 100%" type="button" disabled="true">Download evaluations (<span id="nb_processed">0</span> / <span id="nb_crossroads">-</span>)</button>
                    </div>
                    <div  class="col-6">
                        <button id="next" class="btn btn-primary" style="width: 100%" type="button">Next crossroad</button>
                    </div>
                    </div>
                </div>
            </div>
            <div id="the_end">
                 <div class="position-absolute top-50 start-50 translate-middle fs-1">
                        <p>Download <code>json</code> file</p>
                        <button id="download_end" class="btn btn-primary" type="button" style="width: 100%">Get evaluations</button>
                 </div>
            </div>
        </div>
    </body>
</html>
